<div class="page-root p-10">
  <div class="max-w-[1400px] mx-auto space-y-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold tracking-tight text-foreground">Rspamd Configuration</h1>
      <p class="text-muted-foreground mt-1">Configure spam filtering and machine learning analysis</p>
    </div>

    <!-- Status Badge -->
    @if (status) {
      <div class="flex items-center gap-3 bg-card border border-border px-4 py-2 rounded-xl shadow-sm">
        <div [class]="'p-2 rounded-full ' + (status.status === 'UP' ? 'bg-accent/10 text-accent' : 'bg-destructive/10 text-destructive')">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            @if (status.status === 'UP') {
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
            } @else {
              <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
            }
          </svg>
        </div>
        <div>
          <div class="text-xs font-bold uppercase tracking-wider text-muted-foreground leading-none mb-1">Filter Status</div>
          <div class="text-sm font-bold flex items-center gap-2">
            <span [class]="status.status === 'UP' ? 'text-accent' : 'text-destructive'">{{ status.status }}</span>
            @if (status.version && status.version !== 'unknown') {
              <span class="text-muted-foreground font-normal text-xs border-l border-border pl-2">{{ status.version }}</span>
            }
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Statistics Cards -->
  @if (status && status.status === 'UP') {
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="card p-6 flex flex-col items-center justify-center text-center space-y-2 border-l-4 border-l-primary">
        <span class="text-xs font-bold uppercase tracking-widest text-muted-foreground">Total Scanned</span>
        <div class="text-3xl font-extrabold text-foreground">{{ formatNumber(status.scannedTotal) }}</div>
        <div class="h-1 w-12 bg-primary/20 rounded-full"></div>
      </div>

      <div class="card p-6 flex flex-col items-center justify-center text-center space-y-2 border-l-4 border-l-destructive">
        <span class="text-xs font-bold uppercase tracking-widest text-muted-foreground">Spam Detected</span>
        <div class="text-3xl font-extrabold text-destructive">{{ formatNumber(status.spamCount) }}</div>
        <div class="badge-destructive px-2 py-0.5 text-[10px]">{{ getSpamPercentage() }}% of total</div>
      </div>

      <div class="card p-6 flex flex-col items-center justify-center text-center space-y-2 border-l-4 border-l-accent">
        <span class="text-xs font-bold uppercase tracking-widest text-muted-foreground">Legitimate</span>
        <div class="text-3xl font-extrabold text-accent">{{ formatNumber(status.hamCount) }}</div>
        <div class="h-1 w-12 bg-accent/20 rounded-full"></div>
      </div>

      <div class="card p-6 flex flex-col items-center justify-center text-center space-y-2 border-l-4 border-l-blue-500">
        <span class="text-xs font-bold uppercase tracking-widest text-muted-foreground">Uptime</span>
        <div class="text-2xl font-extrabold text-foreground">{{ formatUptime(status.uptime) }}</div>
        <span class="text-[10px] text-muted-foreground font-medium uppercase tracking-tighter">Active Session</span>
      </div>
    </div>
  }

  <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
    <!-- Configuration Form -->
    <div class="xl:col-span-2 space-y-6">
      <div class="card">
        <div class="card-header border-b border-border/50">
          <h3 class="card-title text-lg">Filtering Engine</h3>
          <p class="card-description">Global Rspamd connection and score thresholds</p>
        </div>
        <div class="card-content pt-6">
          <form [formGroup]="configForm" (ngSubmit)="saveConfiguration()" class="space-y-8">
            <!-- Loading Skeleton -->
            @if (loading) {
              <div class="space-y-6">
                <div class="skeleton h-16 w-full"></div>
                <div class="grid grid-cols-2 gap-4">
                  <div class="skeleton h-12 w-full"></div>
                  <div class="skeleton h-12 w-full"></div>
                </div>
                <div class="skeleton h-48 w-full"></div>
              </div>
            }

            <!-- Form Fields -->
            @if (!loading) {
              <div class="space-y-8">
                <!-- Enable Toggle -->
                <div class="flex items-center justify-between p-4 bg-muted/30 rounded-xl border border-border group hover:border-primary/30 transition-colors">
                  <div class="flex items-start gap-4">
                    <div class="p-2.5 rounded-lg bg-background border border-border text-primary shadow-sm">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                      </svg>
                    </div>
                    <div>
                      <h4 class="font-bold text-foreground">Active Filtering</h4>
                      <p class="text-sm text-muted-foreground">Enable machine learning based spam analysis for all traffic</p>
                    </div>
                  </div>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" formControlName="enabled" class="sr-only peer">
                    <div class="w-11 h-6 bg-muted peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-ring rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                  </label>
                </div>

                <!-- Connection Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div class="space-y-2">
                    <label class="text-sm font-bold text-foreground">Rspamd Host</label>
                    <div class="relative">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="absolute left-3 top-3 text-muted-foreground">
                        <rect width="20" height="8" x="2" y="2" rx="2" ry="2"/><rect width="20" height="8" x="2" y="14" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/>
                      </svg>
                      <input type="text" formControlName="host" class="input pl-10" placeholder="localhost" />
                    </div>
                  </div>

                  <div class="space-y-2">
                    <label class="text-sm font-bold text-foreground">Port</label>
                    <div class="relative">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="absolute left-3 top-3 text-muted-foreground">
                        <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                      </svg>
                      <input type="number" formControlName="port" class="input pl-10" placeholder="11333" />
                    </div>
                  </div>
                </div>

                <div class="space-y-2">
                  <label class="text-sm font-bold text-foreground">API Key (Optional)</label>
                  <div class="relative">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="absolute left-3 top-3 text-muted-foreground">
                      <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3m-3-3l2.5-2.5"/>
                    </svg>
                    <input type="password" formControlName="apiKey" class="input pl-10" placeholder="Password or API token" />
                  </div>
                </div>

                <!-- Thresholds Section -->
                <div class="space-y-6">
                  <div class="flex items-center gap-3">
                    <h4 class="text-xs font-bold uppercase tracking-widest text-muted-foreground">Thresholds & Scoring</h4>
                    <div class="h-[1px] flex-1 bg-border/60"></div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-3">
                      <label class="text-xs font-bold uppercase text-foreground">Reject Score</label>
                      <input type="number" formControlName="rejectScore" class="input border-destructive/30 focus:ring-destructive/20" />
                      <div class="p-3 rounded-lg bg-destructive/5 border border-destructive/10 flex items-start gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="text-destructive mt-0.5 flex-shrink-0">
                          <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                        <span class="text-[11px] font-medium text-destructive leading-tight">HARD REJECT above {{ configForm.get('rejectScore')?.value }}</span>
                      </div>
                    </div>

                    <div class="space-y-3">
                      <label class="text-xs font-bold uppercase text-foreground">Add Header</label>
                      <input type="number" formControlName="addHeaderScore" class="input border-orange-400/30 focus:ring-orange-400/20" />
                      <div class="p-3 rounded-lg bg-orange-400/5 border border-orange-400/10 flex items-start gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="text-orange-500 mt-0.5 flex-shrink-0">
                          <path d="M12 9v4"/><path d="M12 17h.01"/><path d="m12.8 2.2 7.2 11.2c.8 1.2 0 2.6-1.6 2.6H5.6c-1.6 0-2.4-1.4-1.6-2.6l7.2-11.2c.4-.6 1.2-.6 1.6 0z"/>
                        </svg>
                        <span class="text-[11px] font-medium text-orange-600 leading-tight">MARK AS SPAM above {{ configForm.get('addHeaderScore')?.value }}</span>
                      </div>
                    </div>

                    <div class="space-y-3">
                      <label class="text-xs font-bold uppercase text-foreground">Greylist</label>
                      <input type="number" formControlName="greylistScore" class="input border-blue-400/30 focus:ring-blue-400/20" />
                      <div class="p-3 rounded-lg bg-blue-400/5 border border-blue-400/10 flex items-start gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="text-blue-500 mt-0.5 flex-shrink-0">
                          <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <span class="text-[11px] font-medium text-blue-600 leading-tight">TEMP FAIL above {{ configForm.get('greylistScore')?.value || 0 }}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Form Actions -->
                <div class="flex items-center justify-between pt-8 border-t border-border">
                  <button
                    type="button"
                    (click)="testConnection()"
                    [disabled]="testing || configForm.invalid"
                    class="btn-outline flex items-center gap-2 px-6 h-11"
                  >
                    @if (testing) {
                      <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      Testing...
                    } @else {
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
                      </svg>
                      Test Connection
                    }
                  </button>

                  <div class="flex items-center gap-3">
                    <button
                      type="button"
                      (click)="resetForm()"
                      [disabled]="saving || loading"
                      class="btn-ghost font-bold uppercase tracking-widest text-[10px]"
                    >
                      Reset Changes
                    </button>
                    <button
                      type="submit"
                      [disabled]="saving || configForm.invalid || configForm.pristine"
                      class="btn-primary flex items-center gap-2 px-8 h-11 shadow-lg shadow-primary/20"
                    >
                      @if (saving) {
                        <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Saving...
                      } @else {
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Update Engine
                      }
                    </button>
                  </div>
                </div>
              </div>
            }
          </form>
        </div>
      </div>
    </div>

    <!-- Sidebar Help/Info -->
    <div class="space-y-6">
      <div class="card bg-muted/20">
        <div class="card-header pb-4">
          <div class="flex items-center gap-2 text-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
            </svg>
            <h4 class="font-bold">Scoring Help</h4>
          </div>
        </div>
        <div class="card-content space-y-4">
          <div class="space-y-2">
            <h5 class="text-xs font-bold uppercase text-foreground">Score Range</h5>
            <p class="text-xs text-muted-foreground leading-relaxed">
              Rspamd uses a probabilistic score where <span class="text-foreground font-semibold">0</span> is clean and <span class="text-foreground font-semibold">15+</span> is highly likely spam.
            </p>
          </div>
          <div class="space-y-2 pt-2 border-t border-border">
            <h5 class="text-xs font-bold uppercase text-foreground">Common Rules</h5>
            <ul class="text-[11px] space-y-1.5 text-muted-foreground list-disc pl-4">
              <li>Bayesian statistical analysis</li>
              <li>SPF/DKIM/DMARC verification</li>
              <li>DNS Blacklist (DNSBL) lookups</li>
              <li>Neural network scoring</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header border-b border-border/50 pb-3">
          <h4 class="text-sm font-bold">Setup Guide</h4>
        </div>
        <div class="card-content pt-4 space-y-4">
          <div class="flex gap-3">
            <div class="h-6 w-6 rounded bg-primary/10 text-primary flex-shrink-0 flex items-center justify-center text-xs font-bold">1</div>
            <p class="text-xs leading-normal text-muted-foreground">Install the <code class="bg-muted px-1">rspamd</code> package on your Linux node.</p>
          </div>
          <div class="flex gap-3">
            <div class="h-6 w-6 rounded bg-primary/10 text-primary flex-shrink-0 flex items-center justify-center text-xs font-bold">2</div>
            <p class="text-xs leading-normal text-muted-foreground">Enable the <code class="bg-muted px-1">controller</code> worker for API access.</p>
          </div>
          <div class="flex gap-3">
            <div class="h-6 w-6 rounded bg-primary/10 text-primary flex-shrink-0 flex items-center justify-center text-xs font-bold">3</div>
            <p class="text-xs leading-normal text-muted-foreground">Test connectivity from Robin UI using the button below.</p>
          </div>
        </div>
        <div class="card-footer bg-primary/[0.03] pt-4 pb-4">
          <a href="https://rspamd.com/doc/configuration/" target="_blank" class="text-xs font-bold text-primary flex items-center gap-1.5 hover:underline">
            Advanced Configuration
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>


