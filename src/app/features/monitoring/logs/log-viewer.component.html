<div class="page-root p-10">
  <div class="max-w-[1400px] mx-auto space-y-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
      <div>
        <h1 class="text-3xl font-bold tracking-tight text-foreground">System Logs</h1>
        <p class="text-muted-foreground mt-1">Real-time application diagnostics and traffic monitoring</p>
      </div>

      <div class="flex items-center gap-3">
        <!-- Auto-refresh Toggle -->
        <button 
          (click)="toggleAutoRefresh()" 
          [class]="'btn-sm flex items-center gap-2 px-4 transition-all ' + (autoRefresh ? 'btn-primary shadow-lg shadow-primary/20' : 'btn-outline')"
        >
          @if (autoRefresh) {
            <svg class="animate-spin h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Live Monitoring
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10 15 15 20 20 15"/><path d="M4 4V9H9"/><path d="M20 20V15H15"/><path d="M4 9A9 9 0 0 1 15 4"/><path d="M20 15A9 9 0 0 1 9 20"/>
            </svg>
            Auto-refresh Paused
          }
        </button>

        <button (click)="refreshLogs()" class="btn-outline btn-icon h-9 w-9" title="Refresh Logs">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/>
          </svg>
        </button>

        <div class="flex items-center bg-muted/20 border border-border rounded-lg p-1">
          <button (click)="downloadLogs('txt')" class="btn-ghost btn-sm text-[10px] font-bold uppercase tracking-widest px-3">TXT</button>
          <div class="w-[1px] h-4 bg-border"></div>
          <button (click)="downloadLogs('json')" class="btn-ghost btn-sm text-[10px] font-bold uppercase tracking-widest px-3">JSON</button>
        </div>
      </div>
    </div>

    <!-- Filters Bar -->
    <div class="card border-none shadow-sm overflow-visible">
      <div class="p-6">
        <form [formGroup]="filterForm" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
            <!-- Search -->
            <div class="md:col-span-4 space-y-2">
              <label class="text-xs font-bold uppercase tracking-widest text-muted-foreground">Search Pattern</label>
              <div class="relative">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="absolute left-3 top-3 text-muted-foreground">
                  <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
                </svg>
                <input type="text" formControlName="search" class="input pl-10 bg-muted/10 border-muted-foreground/10 focus:bg-background transition-all" placeholder="Filter by message content..." />
              </div>
            </div>

            <!-- Log Level -->
            <div class="md:col-span-2 space-y-2">
              <label class="text-xs font-bold uppercase tracking-widest text-muted-foreground">Level</label>
              <select formControlName="level" class="input bg-muted/10 border-muted-foreground/10 appearance-none">
                <option value="">All Levels</option>
                @for (level of logLevels; track level) {
                  <option [value]="level">{{ level }}</option>
                }
              </select>
            </div>

            <!-- Logger -->
            <div class="md:col-span-3 space-y-2">
              <label class="text-xs font-bold uppercase tracking-widest text-muted-foreground">Source Module</label>
              <select formControlName="logger" class="input bg-muted/10 border-muted-foreground/10 appearance-none">
                <option value="">All Modules</option>
                @for (logger of availableLoggers; track logger) {
                  <option [value]="logger">{{ logger }}</option>
                }
              </select>
            </div>

            <!-- Actions -->
            <div class="md:col-span-3 flex items-end">
              <button (click)="clearFilters()" class="btn-ghost btn-sm w-full flex items-center justify-center gap-2 text-muted-foreground hover:text-foreground">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                </svg>
                Clear Filters
              </button>
            </div>
          </div>
          
          <!-- Date Range (Advanced) -->
          <div class="grid grid-cols-1 md:grid-cols-12 gap-6 pt-4 border-t border-border/40">
            <div class="md:col-span-4 space-y-2">
              <label class="text-xs font-bold uppercase tracking-widest text-muted-foreground">Start Time</label>
              <input type="datetime-local" formControlName="startTime" class="input bg-muted/10 border-muted-foreground/10" />
            </div>
            <div class="md:col-span-4 space-y-2">
              <label class="text-xs font-bold uppercase tracking-widest text-muted-foreground">End Time</label>
              <input type="datetime-local" formControlName="endTime" class="input bg-muted/10 border-muted-foreground/10" />
            </div>
            <div class="md:col-span-4 flex items-end justify-between px-2 text-[10px] font-bold uppercase tracking-tighter text-muted-foreground">
              <span>Showing: <span class="text-foreground">{{ logs.length }}</span></span>
              <span>Total: <span class="text-foreground">{{ totalLogs }}</span></span>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Logs Container -->
    <div class="card border-none shadow-xl overflow-hidden terminal-bg ring-1 ring-white/5">
      <div class="card-header terminal-header border-b border-white/5 py-3 px-6 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="h-2 w-2 rounded-full bg-accent animate-pulse"></div>
          <span class="text-[10px] font-bold uppercase tracking-widest text-muted-foreground">Streaming Output</span>
        </div>
        <div class="flex items-center gap-4 text-[10px] font-mono text-white/40">
          <span>{{ logs.length }} entries loaded</span>
          @if (loading) {
            <span class="flex items-center gap-1.5 text-accent">
              <svg class="animate-spin h-3 w-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
              Updating...
            </span>
          }
        </div>
      </div>
      
      @if (!loading && logs.length === 0) {
        <!-- Empty State -->
        <div class="flex flex-col items-center justify-center py-32 text-center">
          <div class="p-6 rounded-full bg-white/5 text-white/10 mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/>
            </svg>
          </div>
          <h3 class="text-xl font-bold text-white/60">No log entries captured</h3>
          <p class="text-white/30 text-sm max-w-sm mt-2">Adjust your filters or search criteria to locate specific system activities.</p>
        </div>
      } @else {
        <!-- Virtual Scroll Viewport -->
        <cdk-virtual-scroll-viewport [itemSize]="itemSize" class="log-viewport scrollbar-thin scrollbar-thumb-white/10 scrollbar-track-transparent">
          <div *cdkVirtualFor="let log of logs; trackBy: trackByLogId" class="log-entry group border-b border-white/[0.03] hover:bg-white/[0.02] transition-colors">
            <div class="flex items-start px-6 py-3">
              <!-- Level and Timestamp Indicator -->
              <div class="flex-shrink-0 w-32 flex flex-col pt-1">
                <span [class]="'text-[10px] font-bold px-2 py-0.5 rounded-sm inline-block w-fit mb-1.5 ' + (
                  log.level === 'ERROR' ? 'bg-destructive/20 text-destructive' :
                  log.level === 'WARN' ? 'bg-orange-500/20 text-orange-400' :
                  log.level === 'INFO' ? 'bg-accent/20 text-accent' :
                  'bg-white/10 text-white/40'
                )">
                  {{ log.level }}
                </span>
                <span class="text-[9px] font-mono text-white/30">{{ formatTimestamp(log.timestamp) | slice:11:19 }}</span>
              </div>

              <!-- Log Content -->
              <div class="flex-grow min-w-0 space-y-1">
                <!-- Meta Info -->
                <div class="flex items-center gap-3 text-[10px] font-mono opacity-40 group-hover:opacity-100 transition-opacity">
                  <span class="text-accent">{{ log.logger }}</span>
                  @if (log.thread) {
                    <span class="text-white/40">[{{ log.thread }}]</span>
                  }
                </div>

                <!-- Message -->
                <div class="text-white/80 font-mono text-[13px] leading-relaxed break-words">
                  {{ log.message }}
                </div>

                <!-- Stack Trace -->
                @if (log.stackTrace) {
                  <div class="mt-3">
                    <button (click)="toggleStackTrace(log)" class="flex items-center gap-1.5 text-[10px] font-bold uppercase tracking-wider text-destructive/60 hover:text-destructive transition-colors">
                      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" [class.rotate-180]="isStackTraceExpanded(log)" class="transition-transform">
                        <path d="m6 9 6 6 6-6"/>
                      </svg>
                      Exception Detail
                    </button>
                    @if (isStackTraceExpanded(log)) {
                      <pre class="mt-3 p-4 bg-black/40 rounded-lg border border-white/5 text-[11px] text-white/50 overflow-x-auto leading-normal">{{ log.stackTrace }}</pre>
                    }
                  </div>
                }

                <!-- Context -->
                @if (log.context && Object.keys(log.context).length > 0) {
                  <div class="mt-3">
                    <button (click)="toggleContext(log)" class="flex items-center gap-1.5 text-[10px] font-bold uppercase tracking-wider text-accent/60 hover:text-accent transition-colors">
                      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" [class.rotate-180]="isContextExpanded(log)" class="transition-transform">
                        <path d="m6 9 6 6 6-6"/>
                      </svg>
                      Metadata Context
                    </button>
                    @if (isContextExpanded(log)) {
                      <pre class="mt-3 p-3 bg-white/5 rounded-lg text-[10px] text-white/40 font-mono italic overflow-x-auto">{{ log.context | json }}</pre>
                    }
                  </div>
                }
              </div>
            </div>
          </div>
        </cdk-virtual-scroll-viewport>
      }

      <!-- Footer / Load More -->
      @if (hasMore || (loading && logs.length > 0)) {
        <div class="p-6 border-t border-white/5 terminal-footer text-center">
          @if (hasMore && !loading) {
            <button (click)="loadMoreLogs()" class="btn-outline btn-sm border-white/10 text-white/60 hover:bg-white/5 hover:text-white px-8">
              Load Previous Records
            </button>
          }
          @if (loading && logs.length > 0) {
            <div class="flex items-center justify-center gap-3 text-white/40 text-xs font-medium">
              <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
              Fetching more data...
            </div>
          }
        </div>
      }
    </div>
  </div>
</div>